YUI.add("moodle-block_xp-filters",function(i,e){var n,o="filter-add",u="filter",d="filters-list",h="rule",g="rule-rules",t=".filter-add",p=".filter-add a",r=".rule-add",f=".rule-add a",D="> .rule-add",v=".rule-rules .rule-definition",m=".filter-delete",S=".rule-delete",l=".filter",b=".filter-move",F=".filter-rules",k=".filters-list",R=".filters-list > li",a=".rule",_=".rule-definition",x=".rule .rule-move",s=".rule-rules",c=function(){c.superclass.constructor.apply(this,arguments)};i.namespace("M.block_xp").Filters=i.extend(c,i.Base,{addFilterLink:null,canAddFilter:!1,container:null,filterDnD:null,rulepicker:null,rulesDnD:null,rulesetTarget:null,initializer:function(){this.container=i.one(this.get("containerSelector")),this.container.delegate("click",this.addNewFilter,p,this),this.container.delegate("click",this.addNewRule,f,this),this.container.delegate("click",this.deleteFilter,m,this),this.container.delegate("click",this.deleteRule,S,this),null!==this.container.one(t)&&(this.addFilterLink=this.container.one(t).cloneNode(!0),this.canAddFilter=!0),this.prepareRuleDialog(),this.filterDnD=i.namespace("M.block_xp.Filters.DnD").init({containerClass:d,containerSelector:this.get("containerSelector")+" "+k,groups:["filters_"+this.container.generateID()],handleSelector:b,nodeClass:u,nodeSelector:l}),this.filterDnD.on("drag:end",function(){this.fixFilterSortorder()},this),this.filterDnD.on("drop:over",function(){this.fixAddFilterLink()},this),this.rulesDnD={},this.container.all(l).each(function(e){this.setFilterRulesDnD(e)},this)},addNewFilter:function(e){var t=e.currentTarget.get("parentNode"),r=this.getNewFilterTemplate();e.preventDefault(),this.canAddFilter&&t.insert(this.addFilterLink.cloneNode(!0),"after"),t.insert(r,"after"),this.fixFilterSortorder(),this.filterDnD.syncTargets(),this.setFilterRulesDnD(r)},addNewRule:function(e){e.preventDefault(),this.rulepicker||this.prepareRuleDialog(),this.rulesetTarget=e.currentTarget.ancestor(a),this.rulepicker.display()},countChildrenRulesInRule:function(e){e=e.one(s);return e?e.all(a).size():0},deleteFilter:function(e){var t,r;if(e.preventDefault(),t=e.currentTarget.ancestor(l),e=function(){t.remove(),delete this.rulesDnD[t.generateID()],this.fixFilterSortorder(),this.fixAddFilterLink()}.bind(this),(r=(r=t.one(F))?r.one(a):null)&&0<this.countChildrenRulesInRule(r))return(r=new M.core.confirm({title:M.util.get_string("deleterule","block_xp"),question:M.util.get_string("areyousure","core")})).on("complete-yes",e,this),void r.show();e()},deleteRule:function(e){var t,r;if(e.preventDefault(),(t=e.currentTarget.ancestor(a)).ancestor(a,!1,i.bind(function(e){return e==this.container},this))){if(e=function(){t.remove(!0)},0<this.countChildrenRulesInRule(t))return(r=new M.core.confirm({title:M.util.get_string("deletecondition","block_xp"),question:M.util.get_string("areyousure","core")})).on("complete-yes",e,this),void r.show();e()}},fixAddFilterLink:function(){var e,a,s;this.canAddFilter&&(e=this.container.all(R),s=e.size(),e.each(function(e,t){var r=e.hasClass(o),i=!a,n=e.getData("deleted"),l=!i&&a.hasClass(o),t=t-1==s;if(!n){if(i&&!r)e.insert(this.addFilterLink.cloneNode(!0),"before");else{if(!i&&l&&r)return void e.remove();i||l||r?t&&!r&&e.insert(this.addFilterLink.cloneNode(!0),"after"):e.insert(this.addFilterLink.cloneNode(!0),"before")}a=e}},this))},fixFilterSortorder:function(){var e=this.container.all(l),r=0;e.each(function(e){var t=e.getData("basename"),t=e.one('input[name="'+t+'[sortorder]"]');t&&(t.setAttribute("value",r),r++)},this)},generateFilterBasename:function(e){return"filters["+e+"]"},generateRuleBasename:function(e,t){return e+"["+t+"]"},getNewFilterIncrement:function(){var e=this.container.all(l),t=0;return e.each(function(e){e=e.getData("basename"),e=parseInt(/\[([0-9]+)\]$/.exec(e)[1]||0,10);t=t<e?e:t},this),t+1},getNewFilterTemplate:function(){var e=(e=this.get("filter")).replace(this.get("filterTemplateBasename"),this.generateFilterBasename(this.getNewFilterIncrement()));return i.Node.create(e)},getNewRuleIncrement:function(e){var e=e.all(v),t=0;return e.each(function(e){e=e.getData("basename"),e=parseInt(/\[([0-9]+)\]$/.exec(e)[1]||0,10);t=t<e?e:t},this),t+1},newRulePicked:function(e,t){var t=this.get("rules")[t].template,r=this.rulesetTarget.one(s),i=this.generateRuleBasename(r.getData("basename"),this.getNewRuleIncrement(this.rulesetTarget)),t=t.replace(this.get("ruleTemplateBasename"),i);r.insertBefore(t,r.one(D)),this.rulesDnD[r.ancestor(l).generateID()].syncTargets()},prepareRuleDialog:function(){var r=[];i.Object.each(this.get("rules"),function(e,t){r.push({id:t,name:e.name,info:e.info})},this),this.rulepicker=i.namespace("M.block_xp.RulePicker").init({rules:r}),this.rulepicker.on("picked",this.newRulePicked,this)},setFilterRulesDnD:function(e){e.one(s)&&(this.rulesDnD[e.generateID()]=i.namespace("M.block_xp.Filters.DnD").init({additionalDropsSelector:r,dropBeforeSelector:r,containerClass:g,containerSelector:"#"+e.generateID()+" "+s,groups:["rules_"+e.generateID()],handleSelector:x,nodeClass:h,nodeSelector:a}),this.rulesDnD[e.generateID()].on("drop:hit",function(e){var t=e.drag.get("node"),e=e.drop.get("node"),r=t.one(_).getData("basename"),i=e.ancestor(s,!0).getData("basename")+"["+this.getNewRuleIncrement(e.ancestor(a))+"]";t.all("[data-basename], [name]").each(function(e){e.hasAttribute("data-basename")&&e.setAttribute("data-basename",e.getAttribute("data-basename").replace(r,i)),e.hasAttribute("name")&&e.setAttribute("name",e.getAttribute("name").replace(r,i))},this)},this))}},{NAME:e,ATTRS:{containerSelector:{validator:i.Lang.isString,value:null},filter:{validator:i.Lang.isString,value:""},filterTemplateBasename:{value:/filters\[[0-9]+\]/g},rules:{validator:i.Lang.isObject,value:null},ruleTemplateBasename:{value:/XXXXX/g}}}),i.namespace("M.block_xp.Filters").init=function(e){return new c(e)},n=function(){n.superclass.constructor.apply(this,arguments)},i.namespace("M.block_xp.Filters").DnD=i.extend(n,M.core.dragdrop,{
delegate:null,initializer:function(){var e,t;this.groups=this.get("groups"),this.samenodeclass=this.get("nodeClass"),this.parentnodeclass=this.get("containerClass"),(e=new i.DD.Delegate({container:this.get("containerSelector"),nodes:this.get("nodeSelector"),target:!0,handles:[this.get("handleSelector")],dragConfig:{groups:this.groups}})).dd.plug(i.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),e.dd.plug(i.Plugin.DDConstrained,{constrain:this.get("containerSelector")}),e.dd.plug(i.Plugin.DDWinScroll),t=i.one(this.get("containerSelector")),e.createDrop(t,this.groups),this.delegate=e,this.publish("drag:end"),this.publish("drop:hit"),this.publish("drop:over"),this.syncTargets()},global_drop_over:function(e){var t,r;e.drop&&e.drop.inGroup(this.groups)&&(t=e.drag.get("node"),r=e.drop.get("node"),this.lastdroptarget=e.drop,this.get("dropBeforeSelector")&&r.test(this.get("dropBeforeSelector"))?(r.get("parentNode").insertBefore(t,r),this.drop_over(e)):n.superclass.global_drop_over.apply(this,arguments))},drag_end:function(e){this.fire("drag:end",e)},drop_hit:function(e){this.fire("drop:hit",e)},drop_over:function(e){this.fire("drop:over",e)},syncTargets:function(){this.delegate.syncTargets(),this.get("additionalDropsSelector")&&i.one(this.get("containerSelector")).all(this.get("additionalDropsSelector")).each(function(e){this.delegate.createDrop(e,this.groups)},this)}},{NAME:"block_xp-filters-dnd",ATTRS:{additionalDropsSelector:{validator:i.Lang.isString,value:null},containerClass:{validator:i.Lang.isString,value:null},containerSelector:{validator:i.Lang.isString,value:null},dropBeforeSelector:{validator:i.Lang.isString,value:null},groups:{validator:i.Lang.isArray,value:[]},handleSelector:{validator:i.Lang.isString,value:""},nodeClass:{validator:i.Lang.isString,value:null},nodeSelector:{validator:i.Lang.isString,value:null}}}),i.namespace("M.block_xp.Filters.DnD").init=function(e){return new n(e)}},"@VERSION@",{requires:["base","node","moodle-core-dragdrop","moodle-core-notification-confirm","moodle-block_xp-rulepicker"]});