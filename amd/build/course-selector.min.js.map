{"version":3,"file":"course-selector.min.js","sources":["../src/course-selector.js"],"sourcesContent":["// This file is part of Level Up XP.\n//\n// Level Up XP is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Level Up XP is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Level Up XP.  If not, see <https://www.gnu.org/licenses/>.\n//\n// https://levelup.plus\n\n/**\n * Course selector.\n *\n * @copyright  2024 Frédéric Massart\n * @author     Frédéric Massart <fred@branchup.tech>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Modal from 'core/modal';\nimport ModalEvents from 'core/modal_events';\nimport {asyncRender} from 'block_xp/compat';\nimport CourseResourceSelector from 'block_xp/course-resource-selector';\nimport Config from 'core/config';\nimport $ from 'jquery';\n\nexport const openCourseSelector = async(onSelected) => {\n    const {html} = await asyncRender('block_xp/modal-course-selector', {});\n    const modal = new Modal(html);\n    modal.setRemoveOnClose(true);\n\n    const rootJq = modal.getRoot();\n    const root = rootJq[0];\n\n    rootJq.addClass('block_xp');\n    rootJq.on(ModalEvents.shown, () => {\n        const container = root.querySelector('.search-result-contents');\n        const termField = root.querySelector('.search-term-course');\n        const cs = new CourseResourceSelector($(container), $(termField));\n        const recent = getRecentlyUsed();\n        if (recent.length) {\n            cs.displayResults(recent.slice(0, 10));\n        }\n        cs.onResourceSelected(function(e, resource) {\n            saveRecentlyUsed(resource);\n            onSelected(resource.course);\n            modal.hide();\n        });\n    });\n\n    modal.show();\n};\n\nconst getRecentlyUsedCacheKey = () => {\n    const userId = Config.userId;\n    if (!userId) {\n        return null;\n    }\n    return 'block_xp_course_selector_recents_' + userId;\n};\n\nconst getRecentlyUsed = () => {\n    const key = getRecentlyUsedCacheKey();\n    if (!key) {\n        return [];\n    }\n\n    const data = readArrayFromStorage(key);\n    const threshold = Date.now() - 5 * 24 * 60 * 60 * 1000; // 2 days ago.\n    return data.filter(d => d.time > threshold).sort((a, b) => b.time - a.time).map(d => d.resource);\n};\n\nconst readFromStorage = (key, fallback = null) => {\n    try {\n        const data = sessionStorage.getItem(key);\n        return data !== null ? JSON.parse(data) : fallback;\n    } catch (e) {\n        return fallback;\n    }\n};\n\nconst readArrayFromStorage = (key) => {\n    const data = readFromStorage(key, []);\n    return Array.isArray(data) ? data : [];\n};\n\nconst saveRecentlyUsed = (resource) => {\n    const key = getRecentlyUsedCacheKey();\n    if (!key) {\n        return;\n    }\n\n    let data = readArrayFromStorage(key);\n    data = data.filter(d => d.resource.course.id !== resource.course.id);\n    data.push({\n        time: Date.now(),\n        resource: resource,\n    });\n\n    sessionStorage.setItem(key, JSON.stringify(data));\n};\n"],"names":["async","html","modal","Modal","setRemoveOnClose","rootJq","getRoot","root","addClass","on","ModalEvents","shown","container","querySelector","termField","cs","CourseResourceSelector","recent","getRecentlyUsed","length","displayResults","slice","onResourceSelected","e","resource","saveRecentlyUsed","onSelected","course","hide","show","getRecentlyUsedCacheKey","userId","Config","key","data","readArrayFromStorage","threshold","Date","now","filter","d","time","sort","a","b","map","fallback","sessionStorage","getItem","JSON","parse","readFromStorage","Array","isArray","id","push","setItem","stringify"],"mappings":";;;;;;;8WAgCkCA,MAAAA,mBACxBC,KAACA,YAAc,uBAAY,iCAAkC,IAC7DC,MAAQ,IAAIC,eAAMF,MACxBC,MAAME,kBAAiB,SAEjBC,OAASH,MAAMI,UACfC,KAAOF,OAAO,GAEpBA,OAAOG,SAAS,YAChBH,OAAOI,GAAGC,sBAAYC,OAAO,WACnBC,UAAYL,KAAKM,cAAc,2BAC/BC,UAAYP,KAAKM,cAAc,uBAC/BE,GAAK,IAAIC,iCAAuB,mBAAEJ,YAAY,mBAAEE,YAChDG,OAASC,kBACXD,OAAOE,QACPJ,GAAGK,eAAeH,OAAOI,MAAM,EAAG,KAEtCN,GAAGO,oBAAmB,SAASC,EAAGC,UAC9BC,iBAAiBD,UACjBE,WAAWF,SAASG,QACpBzB,MAAM0B,aAId1B,MAAM2B,cAGJC,wBAA0B,WACtBC,OAASC,gBAAOD,cACjBA,OAGE,oCAAsCA,OAFlC,MAKTb,gBAAkB,WACde,IAAMH,8BACPG,UACM,SAGLC,KAAOC,qBAAqBF,KAC5BG,UAAYC,KAAKC,MAAQ,aACxBJ,KAAKK,QAAOC,GAAKA,EAAEC,KAAOL,YAAWM,MAAK,CAACC,EAAGC,IAAMA,EAAEH,KAAOE,EAAEF,OAAMI,KAAIL,GAAKA,EAAEhB,YAYrFW,qBAAwBF,YACpBC,KAVc,SAACD,SAAKa,gEAAW,eAE3BZ,KAAOa,eAAeC,QAAQf,YACpB,OAATC,KAAgBe,KAAKC,MAAMhB,MAAQY,SAC5C,MAAOvB,UACEuB,UAKEK,CAAgBlB,IAAK,WAC3BmB,MAAMC,QAAQnB,MAAQA,KAAO,IAGlCT,iBAAoBD,iBAChBS,IAAMH,8BACPG,eAIDC,KAAOC,qBAAqBF,KAChCC,KAAOA,KAAKK,QAAOC,GAAKA,EAAEhB,SAASG,OAAO2B,KAAO9B,SAASG,OAAO2B,KACjEpB,KAAKqB,KAAK,CACNd,KAAMJ,KAAKC,MACXd,SAAUA,WAGduB,eAAeS,QAAQvB,IAAKgB,KAAKQ,UAAUvB"}