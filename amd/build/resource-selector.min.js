define(["jquery","core/ajax","block_xp/throttler"],function(a,b,c){function d(b,d,e){this._eventNode=a("<div>"),this.container=a(b),this.searchId=0,this.searchTermNode=e,this.resultsContainer=b.find("tbody"),this.emptyResultsNode=b.find(".results-empty"),this.searchingResultsNode=b.find(".searching-results"),this.searchResultsNode=b.find(".search-results"),this.resourceTemplateNode=b.find(".resource-template"),this.resourceTemplateNode.hide(),this.resourceTemplate=this.resourceTemplateNode.clone(),this.resourceTemplate.removeClass("resource-template"),this.resourceTemplate.show(),this.throttler=new c(300),this.searchFunction=d,this._setEventListeners(),this.minChars=3}return d.prototype.clear=function(){this.resultsContainer.empty()},d.prototype.displayEmptyResults=function(){this.searchingResultsNode.hide(),this.emptyResultsNode.show(),this.searchResultsNode.hide()},d.prototype.displayNothing=function(){this.searchingResultsNode.hide(),this.emptyResultsNode.hide(),this.searchResultsNode.hide()},d.prototype.displayResults=function(a){return a&&a.length?(this._publishResults(a),this.searchingResultsNode.hide(),this.emptyResultsNode.hide(),void this.searchResultsNode.show()):void this.displayEmptyResults()},d.prototype.displaySearching=function(){this.searchingResultsNode.show(),this.emptyResultsNode.hide(),this.searchResultsNode.hide()},d.prototype.getResources=function(b){return a.when(this.searchFunction(b))},d.prototype.onResourceSelected=function(a){this._eventNode.on("resource-selected",a)},d.prototype.search=function(a){this.searchId+=1,this._performSearch(a,this.searchId)},d.prototype.setMinChars=function(a){this.minChars=a},d.prototype._onSearchTermKeyUp=function(a){var b=a.target.value;return"string"!=typeof b||b.length<this.minChars?(this.searchingResultsNode.hide(),void this.throttler.cancel()):(this.displaySearching(),this.searchId+=1,void this.throttler.schedule(this._performSearchFactory(b,this.searchId)))},d.prototype._onSelect=function(b){b.preventDefault();var c=a(b.target).closest(".resource-node").data("resource");c&&this._eventNode.trigger("resource-selected",c)},d.prototype._performSearchFactory=function(a,b){return function(){this._performSearch(a,b)}.bind(this)},d.prototype._performSearch=function(a,b){return this.getResources(a).then(function(a){this.searchId==b&&this.displayResults(a)}.bind(this)).fail(function(){this.displayEmptyResults()}.bind(this))},d.prototype._publishResults=function(a){this.clear(),a.forEach(function(a){var b=this.resourceTemplate.clone();b.find(".resource-name").text(a.name),a.subname?b.find(".resource-subname").text(a.subname):b.find(".resource-subname").hide(),b.data("resource",a),this.resultsContainer.append(b)}.bind(this))},d.prototype._setEventListeners=function(){this.searchTermNode.on("keyup",this._onSearchTermKeyUp.bind(this)),this.searchResultsNode.on("click","button",this._onSelect.bind(this))},d});