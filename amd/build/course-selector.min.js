define("block_xp/course-selector",["exports","core/modal","core/modal_events","block_xp/compat","block_xp/course-resource-selector","core/config","jquery"],(function(_exports,_modal,_modal_events,_compat,_courseResourceSelector,_config,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Course selector.
   *
   * @copyright  2024 Frédéric Massart
   * @author     Frédéric Massart <fred@branchup.tech>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.openCourseSelector=void 0,_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_courseResourceSelector=_interopRequireDefault(_courseResourceSelector),_config=_interopRequireDefault(_config),_jquery=_interopRequireDefault(_jquery);_exports.openCourseSelector=async onSelected=>{const{html:html}=await(0,_compat.asyncRender)("block_xp/modal-course-selector",{}),modal=new _modal.default(html);modal.setRemoveOnClose(!0);const rootJq=modal.getRoot(),root=rootJq[0];rootJq.addClass("block_xp"),rootJq.on(_modal_events.default.shown,(()=>{const container=root.querySelector(".search-result-contents"),termField=root.querySelector(".search-term-course"),cs=new _courseResourceSelector.default((0,_jquery.default)(container),(0,_jquery.default)(termField)),recent=getRecentlyUsed();recent.length&&cs.displayResults(recent.slice(0,10)),cs.onResourceSelected((function(e,resource){saveRecentlyUsed(resource),onSelected(resource.course),modal.hide()}))})),modal.show()};const getRecentlyUsedCacheKey=()=>{const userId=_config.default.userId;return userId?"block_xp_course_selector_recents_"+userId:null},getRecentlyUsed=()=>{const key=getRecentlyUsedCacheKey();if(!key)return[];const data=readArrayFromStorage(key),threshold=Date.now()-432e6;return data.filter((d=>d.time>threshold)).sort(((a,b)=>b.time-a.time)).map((d=>d.resource))},readArrayFromStorage=key=>{const data=function(key){let fallback=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{const data=sessionStorage.getItem(key);return null!==data?JSON.parse(data):fallback}catch(e){return fallback}}(key,[]);return Array.isArray(data)?data:[]},saveRecentlyUsed=resource=>{const key=getRecentlyUsedCacheKey();if(!key)return;let data=readArrayFromStorage(key);data=data.filter((d=>d.resource.course.id!==resource.course.id)),data.push({time:Date.now(),resource:resource}),sessionStorage.setItem(key,JSON.stringify(data))}}));

//# sourceMappingURL=course-selector.min.js.map