{"version":3,"file":"resource-selector.min.js","sources":["../src/resource-selector.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Resource selector.\n *\n * @module     block_xp/resource-selector\n * @copyright  2018 Frédéric Massart\n * @author     Frédéric Massart <fred@branchup.tech>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'block_xp/throttler', 'core/pending'], function($, Throttler, Pending) {\n    /**\n     * Resource selector.\n     *\n     * @param {String|jQuery} container The container of the contents.\n     * @param {Function} searchFunction The search function.\n     * @param {jQuery} searchTermFieldNode The input field in which the use searches.\n     */\n    function ResourceSelector(container, searchFunction, searchTermFieldNode) {\n        this._eventNode = $('<div>');\n        this.container = $(container);\n\n        this.searchId = 0;\n        this.searchTermNode = searchTermFieldNode;\n\n        this.resultsContainer = container.find('tbody');\n        this.emptyResultsNode = container.find('.results-empty');\n        this.searchingResultsNode = container.find('.searching-results');\n        this.searchResultsNode = container.find('.search-results');\n\n        this.resourceTemplateNode = container.find('.resource-template');\n        this.resourceTemplateNode.hide();\n        this.resourceTemplate = this.resourceTemplateNode.clone();\n        this.resourceTemplate.removeClass('resource-template');\n        this.resourceTemplate.show();\n\n        this.throttler = new Throttler(300);\n        this.searchFunction = searchFunction;\n        this._setEventListeners();\n        this.minChars = 3;\n    }\n\n    ResourceSelector.prototype.clear = function() {\n        this.resultsContainer.empty();\n    };\n\n    ResourceSelector.prototype.displayEmptyResults = function() {\n        this.searchingResultsNode.hide();\n        this.emptyResultsNode.show();\n        this.searchResultsNode.hide();\n    };\n\n    ResourceSelector.prototype.displayNothing = function() {\n        this.searchingResultsNode.hide();\n        this.emptyResultsNode.hide();\n        this.searchResultsNode.hide();\n    };\n\n    ResourceSelector.prototype.displayResults = function(resources) {\n        if (!resources || !resources.length) {\n            this.displayEmptyResults();\n            return;\n        }\n\n        this._publishResults(resources);\n        this.searchingResultsNode.hide();\n        this.emptyResultsNode.hide();\n        this.searchResultsNode.show();\n    };\n\n    ResourceSelector.prototype.displaySearching = function() {\n        this.searchingResultsNode.show();\n        this.emptyResultsNode.hide();\n        this.searchResultsNode.hide();\n    };\n\n    ResourceSelector.prototype.flagPendingSearch = function() {\n        if (this._pendingSearch) {\n            this._pendingSearch.resolve();\n        }\n        this._pendingSearch = new Pending('resource-selector-search');\n    };\n\n    ResourceSelector.prototype.flagPendingSearchComplete = function() {\n        if (!this._pendingSearch) {\n            return;\n        }\n        this._pendingSearch.resolve();\n        this._pendingSearch = null;\n    };\n\n    /**\n     * Get resources.\n     *\n     * @param {String} term The term to get the results from.\n     * @return {Promise}\n     */\n    ResourceSelector.prototype.getResources = function(term) {\n        return $.when(this.searchFunction(term));\n    };\n\n    ResourceSelector.prototype.onResourceSelected = function(callback) {\n        this._eventNode.on('resource-selected', callback);\n    };\n\n    ResourceSelector.prototype.search = function(term) {\n        this.searchId += 1;\n        this._performSearch(term, this.searchId);\n    };\n\n    ResourceSelector.prototype.setMinChars = function(minChars) {\n        this.minChars = minChars;\n    };\n\n    ResourceSelector.prototype._onSearchTermKeyUp = function(e) {\n        this.flagPendingSearch();\n        var term = e.target.value;\n        if (typeof term !== 'string' || term.length < this.minChars) {\n            this.searchingResultsNode.hide();\n            this.throttler.cancel();\n            this.flagPendingSearchComplete();\n            return;\n        }\n\n        this.displaySearching();\n        this.searchId += 1;\n        this.throttler.schedule(this._performSearchFactory(term, this.searchId));\n    };\n\n    ResourceSelector.prototype._onSelect = function(e) {\n        e.preventDefault();\n        var resource = $(e.target)\n            .closest('.resource-node')\n            .data('resource');\n        if (!resource) {\n            return;\n        }\n        this._eventNode.trigger('resource-selected', resource);\n    };\n\n    ResourceSelector.prototype._performSearchFactory = function(term, searchId) {\n        return function() {\n            this._performSearch(term, searchId).then(function() {\n                this.flagPendingSearchComplete();\n                return;\n            }.bind(this)).catch(function() {\n                this.flagPendingSearchComplete();\n            }.bind(this));\n        }.bind(this);\n    };\n\n    ResourceSelector.prototype._performSearch = function(term, scheduledSearchId) {\n        return this.getResources(term)\n            .then(\n                function(data) {\n                    if (this.searchId != scheduledSearchId) {\n                        return;\n                    }\n                    this.displayResults(data);\n                }.bind(this)\n            )\n            .fail(\n                function() {\n                    this.displayEmptyResults();\n                }.bind(this)\n            );\n    };\n\n    ResourceSelector.prototype._publishResults = function(resources) {\n        this.clear();\n\n        resources.forEach(\n            function(resource) {\n                var node = this.resourceTemplate.clone();\n                node.find('.resource-name').text(resource.name);\n                if (resource.subname) {\n                    node.find('.resource-subname').text(resource.subname);\n                } else {\n                    node.find('.resource-subname').hide();\n                }\n                node.data('resource', resource);\n                this.resultsContainer.append(node);\n            }.bind(this)\n        );\n    };\n\n    ResourceSelector.prototype._setEventListeners = function() {\n        this.searchTermNode.on('keyup', this._onSearchTermKeyUp.bind(this));\n        this.searchResultsNode.on('click', 'button', this._onSelect.bind(this));\n    };\n\n    return ResourceSelector;\n});\n"],"names":["define","$","Throttler","Pending","ResourceSelector","container","searchFunction","searchTermFieldNode","_eventNode","searchId","searchTermNode","resultsContainer","find","emptyResultsNode","searchingResultsNode","searchResultsNode","resourceTemplateNode","hide","resourceTemplate","this","clone","removeClass","show","throttler","_setEventListeners","minChars","prototype","clear","empty","displayEmptyResults","displayNothing","displayResults","resources","length","_publishResults","displaySearching","flagPendingSearch","_pendingSearch","resolve","flagPendingSearchComplete","getResources","term","when","onResourceSelected","callback","on","search","_performSearch","setMinChars","_onSearchTermKeyUp","e","target","value","cancel","schedule","_performSearchFactory","_onSelect","preventDefault","resource","closest","data","trigger","then","bind","catch","scheduledSearchId","fail","forEach","node","text","name","subname","append"],"mappings":"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"}